generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ユーザー
model User {
  id               String   @id @default(uuid())
  firebaseUid      String   @unique @map("firebase_uid")
  email            String   @unique
  displayName      String?  @map("display_name")
  level            Int      @default(1)
  totalXp          Int      @default(0) @map("total_xp")
  currentStreak    Int      @default(0) @map("current_streak")
  longestStreak    Int      @default(0) @map("longest_streak")
  lastTrainingDate DateTime? @map("last_training_date")
  preferredModes   Json?    @map("preferred_modes")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  trainingSessions TrainingSession[]
  answers          Answer[]
  subscription     Subscription?
  achievements     Achievement[]
  leagueParticipations LeagueParticipant[]

  @@map("users")
}

// トレーニングモード
enum TrainingMode {
  BUSINESS     // ビジネス基礎
  PRESENTATION // プレゼン・説明
  ONE_ON_ONE   // 1on1・FB
  DAILY_TALK   // 日常会話
  THINKING     // 思考整理
}

// トレーニングタイプ
enum TrainingType {
  QUICK      // 瞬発力モード
  STRUCTURED // 構造化モード
  AI_DIALOG  // AI対話モード
}

// 問題
model Question {
  id           String       @id @default(uuid())
  mode         TrainingMode
  trainingType TrainingType @map("training_type")
  method       String?      // PREP, STAR, 5W1H など
  title        String
  context      String?      // 状況説明
  hint         String?
  sampleAnswer String?      @map("sample_answer")
  difficulty   Int          @default(1) // 1-5
  isPremium    Boolean      @default(false) @map("is_premium")
  createdAt    DateTime     @default(now()) @map("created_at")

  answers Answer[]

  @@map("questions")
}

// トレーニングセッション
model TrainingSession {
  id             String       @id @default(uuid())
  userId         String       @map("user_id")
  mode           TrainingMode
  trainingType   TrainingType @map("training_type")
  startedAt      DateTime     @default(now()) @map("started_at")
  completedAt    DateTime?    @map("completed_at")
  totalXpEarned  Int          @default(0) @map("total_xp_earned")
  questionsCount Int          @default(0) @map("questions_count")

  user    User     @relation(fields: [userId], references: [id])
  answers Answer[]

  @@map("training_sessions")
}

// 回答
model Answer {
  id               String   @id @default(uuid())
  sessionId        String   @map("session_id")
  questionId       String   @map("question_id")
  userId           String   @map("user_id")
  content          String
  score            Int?     // 0-100
  scoreDetail      Json?    @map("score_detail") // { specificity, structure, persuasiveness }
  feedback         String?
  improvements     Json?    // 改善ポイント配列
  timeSpentSeconds Int?     @map("time_spent_seconds")
  createdAt        DateTime @default(now()) @map("created_at")

  session  TrainingSession @relation(fields: [sessionId], references: [id])
  question Question        @relation(fields: [questionId], references: [id])
  user     User            @relation(fields: [userId], references: [id])

  @@map("answers")
}

// 課金プラン
enum SubscriptionPlan {
  FREE
  PRO
  PRO_YEARLY
}

// 課金ステータス
enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
}

// サブスクリプション
model Subscription {
  id           String             @id @default(uuid())
  userId       String             @unique @map("user_id")
  plan         SubscriptionPlan   @default(FREE)
  status       SubscriptionStatus @default(ACTIVE)
  revenuecatId String?            @map("revenuecat_id")
  startedAt    DateTime?          @map("started_at")
  expiresAt    DateTime?          @map("expires_at")
  createdAt    DateTime           @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@map("subscriptions")
}

// 実績
model Achievement {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  achievementType String   @map("achievement_type") // streak_7, level_10 など
  unlockedAt      DateTime @default(now()) @map("unlocked_at")

  user User @relation(fields: [userId], references: [id])

  @@map("achievements")
}

// リーグティア
enum LeagueTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

// リーグ参加者
model LeagueParticipant {
  id         String     @id @default(uuid())
  userId     String     @map("user_id")
  leagueId   String     @map("league_id") // 週次ID (2024-W01)
  leagueTier LeagueTier @default(BRONZE) @map("league_tier")
  weeklyXp   Int        @default(0) @map("weekly_xp")
  rank       Int?
  createdAt  DateTime   @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, leagueId])
  @@map("league_participants")
}
